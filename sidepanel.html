<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crab-Agent</title>
  <link rel="stylesheet" href="styles/main.css">
</head>

<body>
  <div class="app-container">
    <!-- List View (Task History) -->
    <div class="list-view" id="listView">
      <!-- Tabs -->
      <div class="tabs-container">
        <button class="tab active" data-tab="tasks">AGENT-S</button>
        <button class="tab" data-tab="context">CONTEXT RULES</button>
      </div>

      <!-- Search -->
      <div class="search-container">
        <div class="search-wrapper">
          <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="M21 21l-4.35-4.35"></path>
          </svg>
          <input type="text" class="search-input" id="searchInput" placeholder="Search recent tasks...">
        </div>
      </div>

      <!-- Task List -->
      <div class="task-list" id="taskList">
        <!-- Tasks will be rendered here -->
      </div>

      <!-- Context Rules Panel (inside list view) -->
      <div class="settings-content hidden" id="contextRulesContent">
        <div class="settings-section">
          <div class="settings-section-title">Domain-Specific Context Rules</div>
          <p class="settings-description" style="margin-bottom: 16px;">
            Add custom instructions for specific domains. When you're on a matching page, these rules will automatically
            be added to the AI's context.
          </p>
          <div id="rulesList">
            <!-- Rules will be rendered here -->
          </div>
          <button class="add-rule-btn" id="addRuleBtn">+ Add New Rule</button>
        </div>
      </div>

      <!-- New Task Button -->
      <button class="new-task-btn" id="newTaskBtn">+ New Task</button>
    </div>

    <!-- Chat View -->
    <div class="chat-container" id="chatView">
      <!-- Chat Header -->
      <div class="header">
        <div class="header-left">
          <button class="back-btn" id="backBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"></path>
            </svg>
          </button>
          <span class="header-title" id="chatTitle">New Task</span>
        </div>
        <div class="header-actions">
          <button class="header-btn" id="timerBtn" title="Execution time">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 6v6l4 2"></path>
            </svg>
            <span id="timerDisplay" style="margin-left: 4px; font-size: 11px;">0:00</span>
          </button>
          <button class="header-btn" id="settingsBtn" title="Settings">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
              </path>
            </svg>
          </button>
          <button class="header-btn" id="openTabBtn" title="Open in new tab">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          </button>
        </div>
      </div>

      <div class="mascot-crab-row">
        <div class="mascot-crab" id="mascotCrab" aria-live="polite" aria-label="Agent mascot crab">
          <div class="mascot-crab-bubble" id="mascotCrabBubble"></div>
          <pre class="mascot-crab-art" id="mascotCrabArt"></pre>
        </div>
      </div>

      <!-- Chat Messages -->
      <div class="chat-messages" id="chatMessages">
        <!-- Messages will be rendered here -->
      </div>

      <!-- Execution Status Bar -->
      <div class="execution-bar" id="executionBar">
        <div class="execution-spinner"></div>
        <span class="execution-text" id="executionText">Thinking...</span>
        <span class="execution-step" id="executionStep">Step 1/100</span>
        <button class="cancel-btn" id="cancelBtn">Cancel</button>
      </div>

      <!-- Chat Input -->
      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <div class="chat-input-row">
            <textarea class="chat-input" id="chatInput" placeholder="Ask Crab-Agent to do something..."
              rows="1"></textarea>
            <button class="send-btn" id="sendBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </div>
          <div class="chat-options">
            <button class="option-btn" id="modelBtn">GPT-4o</button>
            <button class="option-btn" id="visionBtn">Vision: ON</button>
            <button class="option-btn attach-btn" id="attachBtn" title="Attach images" aria-label="Attach images">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                  d="M21.44 11.05l-8.49 8.49a6 6 0 1 1-8.49-8.49l8.49-8.49a4 4 0 1 1 5.66 5.66l-8.5 8.49a2 2 0 0 1-2.83-2.83l7.78-7.78">
                </path>
              </svg>
            </button>
          </div>
          <div class="attachment-preview hidden" id="attachmentPreview"></div>
          <input type="file" class="image-input" id="imageInput" accept="image/*" multiple>
        </div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
      <div class="header">
        <div class="header-left">
          <button class="back-btn" id="settingsBackBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"></path>
            </svg>
          </button>
          <span class="header-title">Settings</span>
        </div>
      </div>

      <div class="settings-content">
        <!-- API Configuration -->
        <div class="settings-section">
          <div class="settings-section-title">API Configuration</div>

          <div class="settings-item">
            <label class="settings-label">LLM Provider</label>
            <select class="settings-select" id="providerSelect">
              <option value="openai">OpenAI</option>
              <option value="openai-compatible">OpenAI Compatible (Custom)</option>
              <option value="anthropic">Anthropic (Claude)</option>
              <option value="google">Google (Gemini)</option>
              <option value="openrouter">OpenRouter</option>
              <option value="ollama">Ollama (Local)</option>
            </select>
          </div>

          <div class="settings-item">
            <label class="settings-label">API Key</label>
            <input type="password" class="settings-input" id="apiKeyInput" placeholder="Enter your API key">
            <span class="settings-description">Your API key is stored locally and never sent to our servers.</span>
          </div>

          <div class="settings-item">
            <label class="settings-label">Model</label>
            <select class="settings-select" id="modelSelect">
              <option value="gpt-5.2">GPT-5.2 (Latest)</option>
              <option value="gpt-5">GPT-5</option>
              <option value="o3">o3 (Reasoning)</option>
              <option value="o3-mini">o3-mini</option>
              <option value="gpt-4o">GPT-4o</option>
              <option value="gpt-4o-mini">GPT-4o Mini</option>
              <option value="gpt-4-turbo">GPT-4 Turbo</option>
              <option value="claude-sonnet-4-5-20250514">Claude 4.5 Sonnet</option>
              <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
              <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
              <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            </select>
          </div>

          <div class="settings-item" id="baseUrlItem">
            <label class="settings-label">Base URL</label>
            <input type="text" class="settings-input" id="baseUrlInput" placeholder="https://api.openai.com">
            <span class="settings-description">API endpoint. Examples: https://api.groq.com/openai,
              https://api.together.xyz, http://localhost:1234</span>
          </div>

          <div class="settings-item" id="customModelItem" style="display: none;">
            <label class="settings-label">Custom Model Name</label>
            <input type="text" class="settings-input" id="customModelInput" placeholder="Enter exact model name/ID">
            <span class="settings-description">Enter the exact model name as required by your API provider.</span>
          </div>
        </div>

        <!-- Agent Settings -->
        <div class="settings-section">
          <div class="settings-section-title">Agent Settings</div>

          <div class="settings-toggle">
            <div>
              <div class="settings-label">Use Vision</div>
              <div class="settings-description">Send screenshots to the AI for visual understanding</div>
            </div>
            <div class="toggle-switch active" id="visionToggle"></div>
          </div>

          <div class="settings-toggle">
            <div>
              <div class="settings-label">Auto Scroll</div>
              <div class="settings-description">Automatically scroll to bring elements into view</div>
            </div>
            <div class="toggle-switch active" id="autoScrollToggle"></div>
          </div>

          <div class="settings-item">
            <label class="settings-label">Max Steps</label>
            <input type="number" class="settings-input" id="maxStepsInput" value="100" min="1" max="500">
            <span class="settings-description">Maximum number of actions per task (1-500)</span>
          </div>

          <div class="settings-item">
            <label class="settings-label">Planning Interval</label>
            <input type="number" class="settings-input" id="planningIntervalInput" value="3" min="1" max="10">
            <span class="settings-description">Run planner every N steps to check progress</span>
          </div>
        </div>

        <!-- URL Rules -->
        <div class="settings-section">
          <div class="settings-section-title">URL Rules</div>

          <div class="settings-item">
            <label class="settings-label">Allowed Domains (one per line)</label>
            <textarea class="settings-textarea" id="allowedDomainsInput"
              placeholder="example.com&#10;*.google.com"></textarea>
          </div>

          <div class="settings-item">
            <label class="settings-label">Blocked Domains (one per line)</label>
            <textarea class="settings-textarea" id="blockedDomainsInput"
              placeholder="malware.com&#10;*.dangerous.net"></textarea>
          </div>
        </div>

        <!-- Data Management -->
        <div class="settings-section">
          <div class="settings-section-title">Data Management</div>

          <button class="add-rule-btn" id="exportDataBtn" style="margin-bottom: 8px;">Export All Data</button>
          <button class="add-rule-btn" id="clearHistoryBtn" style="border-color: #ef4444; color: #ef4444;">Clear Chat
            History</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Rule Modal -->
  <div class="modal-overlay" id="ruleModal">
    <div class="modal">
      <div class="modal-title" id="ruleModalTitle">Add Context Rule</div>
      <div class="settings-item">
        <label class="settings-label">Domain Pattern</label>
        <input type="text" class="settings-input" id="ruleDomainInput" placeholder="*.example.com or example.com">
        <span class="settings-description">Use * as wildcard. E.g., *.google.com matches all Google subdomains.</span>
      </div>
      <div class="settings-item">
        <label class="settings-label">Context Instructions</label>
        <textarea class="settings-textarea" id="ruleContextInput"
          placeholder="When on this site, always...&#10;- Use specific selectors&#10;- Follow certain patterns&#10;- Be aware of specific UI elements"
          style="min-height: 120px;"></textarea>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" id="ruleModalCancel">Cancel</button>
        <button class="modal-btn primary" id="ruleModalSave">Save Rule</button>
      </div>
    </div>
  </div>

  <!-- Model Selection Modal -->
  <div class="modal-overlay" id="modelModal">
    <div class="modal">
      <div class="modal-title">Select Model</div>
      <div id="modelList">
        <!-- Models will be rendered here -->
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" id="modelModalCancel">Cancel</button>
      </div>
    </div>
  </div>

  <script src="sidepanel.js"></script>
</body>

</html>
