<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crab-Agent</title>
  <link rel="stylesheet" href="styles/main.css">
  <script src="theme-init.js"></script>
</head>

<body>
  <div class="app-container">
    <!-- Main Chat View -->
    <div class="chat-container" id="chatView">
      <!-- Header -->
      <div class="header">
        <div class="header-left">
          <button class="model-selector" id="modelBtn">
            <span id="modelDisplay">GPT-4o</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"></path>
            </svg>
          </button>
        </div>
        <div class="header-right">
          <button class="icon-btn" id="historyBtn" title="Chat history">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 6v6l4 2"></path>
            </svg>
          </button>
          <button class="icon-btn" id="settingsBtn" title="Settings">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
          <button class="icon-btn" id="menuBtn" title="Menu">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="1"></circle>
              <circle cx="12" cy="5" r="1"></circle>
              <circle cx="12" cy="19" r="1"></circle>
            </svg>
          </button>
        </div>
      </div>

      <!-- Dropdown Menu -->
      <div class="dropdown-menu hidden" id="dropdownMenu">
        <button class="dropdown-item" id="newChatBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"></path>
          </svg>
          New chat
        </button>
        <button class="dropdown-item" id="historyMenuBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
          Chat history
        </button>
        <div class="dropdown-divider"></div>
        <button class="dropdown-item" id="settingsMenuBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
          </svg>
          Settings
        </button>
      </div>

      <!-- Crab Mascot (small, in corner) -->
      <div class="mascot-crab-mini" id="mascotCrab">
        <pre class="mascot-crab-art" id="mascotCrabArt"></pre>
        <div class="mascot-crab-bubble" id="mascotCrabBubble"></div>
      </div>

      <!-- Chat Messages -->
      <div class="chat-messages" id="chatMessages">
        <!-- Messages will be rendered here -->
      </div>

      <!-- Execution Status (minimal) -->
      <div class="execution-bar hidden" id="executionBar">
        <div class="execution-content">
          <div class="execution-spinner"></div>
          <span class="execution-text" id="executionText">Working...</span>
        </div>
        <button class="execution-cancel" id="cancelBtn">Stop</button>
      </div>

      <!-- Chat Input -->
      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <textarea class="chat-input" id="chatInput" placeholder="What would you like me to do?" rows="1"></textarea>
          <div class="input-actions">
            <button class="input-action-btn" id="attachBtn" title="Attach image">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.44 11.05l-8.49 8.49a6 6 0 1 1-8.49-8.49l8.49-8.49a4 4 0 1 1 5.66 5.66l-8.5 8.49a2 2 0 0 1-2.83-2.83l7.78-7.78"></path>
              </svg>
            </button>
            <button class="send-btn" id="sendBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L12 22M12 2L5 9M12 2L19 9" stroke="currentColor" stroke-width="2" fill="none"></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="input-options">
          <button class="option-pill" id="visionBtn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
            Vision
          </button>
          <span class="char-counter" id="charCounter">0 / 10,000</span>
        </div>
        <div class="attachment-preview hidden" id="attachmentPreview"></div>
        <input type="file" class="image-input" id="imageInput" accept="image/*" multiple>
      </div>
    </div>

    <!-- History Panel -->
    <div class="panel hidden" id="historyPanel">
      <div class="panel-header">
        <button class="back-btn" id="historyBackBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"></path>
          </svg>
        </button>
        <span class="panel-title">Chat History</span>
      </div>
      <div class="search-box">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.35-4.35"></path>
        </svg>
        <input type="text" id="searchInput" placeholder="Search chats...">
      </div>
      <div class="task-list" id="taskList"></div>
    </div>

    <!-- Settings Panel -->
    <div class="panel hidden" id="settingsPanel">
      <div class="panel-header">
        <button class="back-btn" id="settingsBackBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"></path>
          </svg>
        </button>
        <span class="panel-title">Settings</span>
      </div>

      <div class="settings-content">
        <!-- API Configuration -->
        <div class="settings-section">
          <div class="settings-section-title">API Configuration</div>
          <div class="settings-item">
            <label class="settings-label">Provider</label>
            <select class="settings-select" id="providerSelect">
              <option value="openai">OpenAI</option>
              <option value="openai-compatible">OpenAI Compatible</option>
              <option value="anthropic">Anthropic</option>
              <option value="google">Google</option>
              <option value="openrouter">OpenRouter</option>
              <option value="ollama">Ollama</option>
            </select>
          </div>
          <div class="settings-item">
            <label class="settings-label">API Key</label>
            <input type="password" class="settings-input" id="apiKeyInput" placeholder="Enter API key">
          </div>
          <div class="settings-item">
            <label class="settings-label">Model</label>
            <select class="settings-select" id="modelSelect">
              <option value="gpt-4o">GPT-4o</option>
              <option value="gpt-4o-mini">GPT-4o Mini</option>
              <option value="claude-sonnet-4-5-20250514">Claude 4.5 Sonnet</option>
              <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
            </select>
          </div>
          <div class="settings-item" id="baseUrlItem">
            <label class="settings-label">Base URL</label>
            <input type="text" class="settings-input" id="baseUrlInput" placeholder="https://api.openai.com">
          </div>
          <div class="settings-item hidden" id="customModelItem">
            <label class="settings-label">Custom Model (optional)</label>
            <input type="text" class="settings-input" id="customModelInput" placeholder="e.g. gpt-4o, llama3.3:latest">
          </div>
        </div>

        <!-- Agent Settings -->
        <div class="settings-section">
          <div class="settings-section-title">Agent</div>
          <div class="settings-toggle">
            <span>Use Vision</span>
            <div class="toggle-switch active" id="visionToggle"></div>
          </div>
          <div class="settings-toggle">
            <span>Auto Scroll</span>
            <div class="toggle-switch active" id="autoScrollToggle"></div>
          </div>
          <div class="settings-toggle">
            <span>Enable Thinking</span>
            <div class="toggle-switch" id="thinkingToggle"></div>
          </div>
          <div class="settings-item">
            <label class="settings-label">Max Steps</label>
            <input type="number" class="settings-input" id="maxStepsInput" value="100" min="1" max="500">
          </div>
          <div class="settings-item">
            <label class="settings-label">Planning Interval</label>
            <input type="number" class="settings-input" id="planningIntervalInput" value="3" min="1" max="10">
          </div>
          <div class="settings-item hidden">
            <label class="settings-label">Thinking Budget</label>
            <input type="number" class="settings-input" id="thinkingBudgetInput" value="1024" min="1024" max="3072">
          </div>
        </div>

        <!-- Appearance -->
        <div class="settings-section">
          <div class="settings-section-title">Appearance</div>
          <div class="settings-item">
            <label class="settings-label">Theme</label>
            <select class="settings-select" id="themeSelect">
              <option value="system">System</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
        </div>

        <!-- URL Rules -->
        <div class="settings-section">
          <div class="settings-section-title">URL Rules</div>
          <div class="settings-item">
            <label class="settings-label">Allowed Domains</label>
            <textarea class="settings-textarea" id="allowedDomainsInput" placeholder="example.com"></textarea>
          </div>
          <div class="settings-item">
            <label class="settings-label">Blocked Domains</label>
            <textarea class="settings-textarea" id="blockedDomainsInput" placeholder="malware.com"></textarea>
          </div>
        </div>

        <!-- Data -->
        <div class="settings-section">
          <div class="settings-section-title">Data</div>
          <button class="settings-btn" id="exportDataBtn">Export Data</button>
          <button class="settings-btn danger" id="clearHistoryBtn">Clear History</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Model Selection Modal -->
  <div class="modal-overlay hidden" id="modelModal">
    <div class="modal">
      <div class="modal-title">Select Model</div>
      <div id="modelList"></div>
      <button class="modal-close" id="modelModalCancel">Cancel</button>
    </div>
  </div>

  <!-- Hidden elements for compatibility -->
  <div style="display:none">
    <span id="chatTitle"></span>
    <span id="timerDisplay"></span>
    <span id="executionStep"></span>
    <div id="listView"></div>
    <div id="contextRulesContent"></div>
    <div id="rulesList"></div>
    <button id="addRuleBtn"></button>
    <button id="newTaskBtn"></button>
    <button id="backBtn"></button>
    <button id="openTabBtn"></button>
    <button id="timerBtn"></button>
    <div id="liveActivityPanel"></div>
    <span id="liveActivityHint"></span>
    <div id="liveActionSlot"></div>
    <div id="liveImageSlot"></div>
    <div id="ruleModal"></div>
    <input id="ruleDomainInput">
    <textarea id="ruleContextInput"></textarea>
    <button id="ruleModalSave"></button>
    <button id="ruleModalCancel"></button>
  </div>

  <script src="sidepanel.js"></script>
</body>

</html>
